import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged
} from 'firebase/auth'; 
import { 
    getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, setLogLevel 
} from 'firebase/firestore'; 

// --- Configuration ---
const APP_EMAIL = 'sarhank1026@gmail.com';
const ADMIN_PHONE = '+91 84879 93896';

// --- Firebase Initialization and Globals ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

// Function to handle exponential backoff for fetch calls (kept for best practice)
const fetchWithRetry = async (url, options, retries = 3) => {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response;
        } catch (error) {
            if (i < retries - 1) {
                const delay = Math.pow(2, i) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                throw error;
            }
        }
    }
};

const ArtGallery = () => {
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [paintings, setPaintings] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [showUploadModal, setShowUploadModal] = useState(false);
    const [showInquiryModal, setShowInquiryModal] = useState(false);
    const [selectedPainting, setSelectedPainting] = useState(null);
    const [uploadForm, setUploadForm] = useState({ title: '', artist: '', price: '', imageUrl: '' });
    const [error, setError] = useState(null);

    // Set up Firebase and Authentication
    useEffect(() => {
        try {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);

            setDb(firestore);

            const unsubscribeAuth = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsLoading(false);
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(authInstance, initialAuthToken);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                    } catch (e) {
                        console.error("Firebase Auth Error:", e);
                        setError("Failed to sign in. Check console for details.");
                        setIsLoading(false);
                    }
                }
            });

            return () => unsubscribeAuth();

        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            setError("Failed to initialize Firebase.");
            setIsLoading(false);
        }
    }, []);

    // Fetch and listen for real-time painting data
    useEffect(() => {
        if (!db || !userId) return;

        const collectionPath = `artifacts/${appId}/public/data/artGallery`;
        const paintingsCollection = collection(db, collectionPath);
        
        const unsubscribeSnapshot = onSnapshot(paintingsCollection, (snapshot) => {
            const fetchedPaintings = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                status: doc.data().status || 'available' // Ensure status defaults to available
            }));
            setPaintings(fetchedPaintings);
            setIsLoading(false); 
        }, (e) => {
            console.error("Firestore Snapshot Error:", e);
            setError("Failed to load paintings from the database.");
            setIsLoading(false);
        });

        return () => unsubscribeSnapshot();
    }, [db, userId]);

    // --- Data Handlers ---

    const handleUploadChange = (e) => {
        setUploadForm({ ...uploadForm, [e.target.name]: e.target.value });
    };

    const handleUploadSubmit = async (e) => {
        e.preventDefault();
        if (!db) {
            setError("Database not initialized.");
            return;
        }

        const { title, artist, price, imageUrl } = uploadForm;
        if (!title || !artist || !price) {
            setError("Please fill in Title, Artist, and Price.");
            return;
        }

        const newPainting = {
            title: title.trim(),
            artist: artist.trim(),
            price: parseFloat(price).toFixed(2),
            imageUrl: imageUrl.trim() || `https://placehold.co/400x300/a35d6a/ffffff?text=${encodeURIComponent(title)}`,
            status: 'available',
            createdAt: new Date().toISOString()
        };

        try {
            setIsLoading(true);
            const collectionPath = `artifacts/${appId}/public/data/artGallery`;
            await addDoc(collection(db, collectionPath), newPainting);
            setUploadForm({ title: '', artist: '', price: '', imageUrl: '' });
            setShowUploadModal(false);
            setError(null);
        } catch (e) {
            console.error("Error adding document: ", e);
            setError("Failed to upload painting. Please try again.");
        } finally {
            setIsLoading(false);
        }
    };
    
    // Function to open the inquiry modal
    const handleBuyNowClick = (painting) => {
        setSelectedPainting(painting);
        setShowInquiryModal(true);
    };

    const handleRemovePainting = async (id) => {
        if (!db) return;
        
        const isConfirmed = window.prompt(`Type 'DELETE' to confirm removing painting ID: ${id}`);
        if (isConfirmed !== 'DELETE') return;

        try {
            setIsLoading(true);
            const docPath = `artifacts/${appId}/public/data/artGallery/${id}`;
            await deleteDoc(doc(db, docPath));
            setError(null);
        } catch (e) {
            console.error("Error removing document: ", e);
            setError("Failed to remove painting.");
        } finally {
            setIsLoading(false);
        }
    };
    
    // --- Inquiry Modal Component ---

    const InquiryModal = ({ painting, onClose }) => {
        const [formData, setFormData] = useState({
            name: '',
            mobile: '',
            email: '',
            address: ''
        });
        const [isSubmitting, setIsSubmitting] = useState(false);

        const handleChange = (e) => {
            setFormData({ ...formData, [e.target.name]: e.target.value });
        };

        const handleSubmitInquiry = async (e) => {
            e.preventDefault();
            if (!db || !painting) return;

            setIsSubmitting(true);

            // 1. Construct the email body
            const subject = encodeURIComponent(`Purchase Inquiry for: ${painting.title}`);
            const body = encodeURIComponent(
                `Hello, I am interested in purchasing the following painting:\n\n` +
                `Painting Title: ${painting.title}\n` +
                `Artist: ${painting.artist}\n` +
                `Price: $${painting.price}\n` +
                `Painting ID: ${painting.id}\n\n` +
                `---\n\n` +
                `My contact details are:\n` +
                `Name: ${formData.name}\n` +
                `Mobile No: ${formData.mobile}\n` +
                `Email: ${formData.email}\n` +
                `Shipping Address: ${formData.address}\n\n` +
                `Please contact me to finalize the transaction.`
            );

            // 2. Open the user's default email client
            const mailtoLink = `mailto:${APP_EMAIL}?subject=${subject}&body=${body}`;
            window.open(mailtoLink, '_blank');

            // 3. Update Firestore status for real-time seller notification
            try {
                const docPath = `artifacts/${appId}/public/data/artGallery/${painting.id}`;
                await updateDoc(doc(db, docPath), {
                    status: 'pending_inquiry',
                    inquiredBy: {
                        name: formData.name,
                        email: formData.email,
                        mobile: formData.mobile,
                        timestamp: new Date().toISOString()
                    },
                });
                setError(null);
            } catch (e) {
                console.error("Error updating inquiry status: ", e);
                setError("Failed to mark item as pending inquiry in the database.");
            } finally {
                setIsSubmitting(false);
                onClose();
                // Optional message to user (using prompt as a simple modal replacement)
                window.prompt("Inquiry Sent! Please check your email client for the draft purchase email. We will contact you soon. Click OK to continue.");
            }
        };

        return (
            <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
                    <h2 className="text-2xl font-bold mb-4 text-indigo-700 border-b pb-2">Purchase Inquiry: {painting.title}</h2>
                    <p className="text-sm text-gray-600 mb-4">Please enter your details below. Clicking "Send Inquiry" will open your email client to send your purchase request to the gallery.</p>
                    <form onSubmit={handleSubmitInquiry} className="space-y-4">
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-gray-700">Full Name</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                value={formData.name}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            />
                        </div>
                        <div>
                            <label htmlFor="mobile" className="block text-sm font-medium text-gray-700">Mobile No.</label>
                            <input
                                type="tel"
                                id="mobile"
                                name="mobile"
                                value={formData.mobile}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            />
                        </div>
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email Address</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                value={formData.email}
                                onChange={handleChange}
                                required
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            />
                        </div>
                        <div>
                            <label htmlFor="address" className="block text-sm font-medium text-gray-700">Shipping Address</label>
                            <textarea
                                id="address"
                                name="address"
                                value={formData.address}
                                onChange={handleChange}
                                rows="3"
                                required
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            />
                        </div>
                        <div className="flex justify-end space-x-3 mt-6">
                            <button
                                type="button"
                                onClick={onClose}
                                disabled={isSubmitting}
                                className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 transition duration-150"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                disabled={isSubmitting}
                                className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:opacity-50 transition duration-150 shadow-md hover:shadow-lg flex items-center space-x-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                                <span>{isSubmitting ? 'Processing...' : 'Send Inquiry'}</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    // --- Components / UI helpers ---

    const UploadModal = ({ onClose }) => (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
                <h2 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Upload New Painting</h2>
                <form onSubmit={handleUploadSubmit} className="space-y-4">
                    {/* Form fields remain the same */}
                    <div>
                        <label htmlFor="title" className="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="title" name="title" value={uploadForm.title} onChange={handleUploadChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                    </div>
                    <div>
                        <label htmlFor="artist" className="block text-sm font-medium text-gray-700">Artist</label>
                        <input type="text" id="artist" name="artist" value={uploadForm.artist} onChange={handleUploadChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                    </div>
                    <div>
                        <label htmlFor="price" className="block text-sm font-medium text-gray-700">Price (USD)</label>
                        <input type="number" id="price" name="price" step="0.01" min="0.01" value={uploadForm.price} onChange={handleUploadChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                    </div>
                    <div>
                        <label htmlFor="imageUrl" className="block text-sm font-medium text-gray-700">Image URL (Optional)</label>
                        <input type="url" id="imageUrl" name="imageUrl" value={uploadForm.imageUrl} onChange={handleUploadChange} placeholder="Enter image URL or a placeholder will be used" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"/>
                    </div>
                    <div className="flex justify-end space-x-3 mt-6">
                        <button type="button" onClick={onClose} disabled={isLoading} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 transition duration-150">Cancel</button>
                        <button type="submit" disabled={isLoading} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 disabled:opacity-50 transition duration-150 shadow-md hover:shadow-lg">
                            {isLoading ? 'Uploading...' : 'Upload Painting'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );

    const PaintingCard = ({ painting }) => {
        const isSold = painting.status === 'sold';
        const isPending = painting.status === 'pending_inquiry';
        const statusClass = isSold ? 'bg-red-500' : isPending ? 'bg-yellow-500' : 'bg-green-500';

        return (
            <div className={`bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition-transform duration-300 hover:scale-[1.02] hover:shadow-2xl ${isSold || isPending ? 'opacity-80' : ''}`}>
                <div className="aspect-w-4 aspect-h-3 overflow-hidden relative">
                    <img
                        src={painting.imageUrl}
                        alt={painting.title}
                        className="w-full h-full object-cover"
                        onError={(e) => {
                            e.target.onerror = null;
                            e.target.src = `https://placehold.co/400x300/e0e0e0/333333?text=Image+Not+Found`;
                        }}
                    />
                    {(isSold || isPending) && (
                        <div className="absolute top-2 right-2 px-3 py-1 text-xs font-bold text-white uppercase rounded-full shadow-md" style={{backgroundColor: statusClass === 'bg-red-500' ? '#ef4444' : '#f59e0b'}}>
                            {isSold ? 'SOLD' : 'Pending Inquiry'}
                        </div>
                    )}
                </div>
                <div className="p-4 flex flex-col flex-grow">
                    <h3 className="text-xl font-semibold text-gray-900 line-clamp-2">{painting.title}</h3>
                    <p className="text-sm text-indigo-600 font-medium mt-1 mb-2">{painting.artist}</p>
                    <div className="flex justify-between items-center mt-auto pt-2 border-t border-gray-100">
                        
                        {/* Price and Status Display */}
                        <p className="text-2xl font-bold text-gray-800">${painting.price}</p>
                        
                        <div className='flex space-x-2 items-center'>
                            {/* Purchase Button - Only available if not sold/pending */}
                            {!isSold && !isPending && (
                                <button
                                    onClick={() => handleBuyNowClick(painting)}
                                    disabled={isLo
